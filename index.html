<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Surf Spots Dakar â€” Live</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#f0f9ff; font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto; }
    .arrow { display:inline-block; width:36px; height:36px; transform-origin: center center; transition: transform 0.4s ease; }
    .spot-card { min-height:220px; }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center p-6">
  <h1 class="text-2xl font-bold mb-6">ðŸŒŠ Surf Spots - Dakar (live)</h1>

  <div id="spots" class="grid md:grid-cols-3 gap-6 w-full max-w-6xl"></div>

  <div id="tides" class="mt-10 bg-white p-4 rounded-2xl shadow w-full max-w-3xl text-center"></div>

  <button id="refreshBtn" class="mt-6 px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700">
    Actualiser les donnÃ©es
  </button>

  <script>
    const API_KEY = "0ec6f6b6-9546-11f0-b41a-0242ac130006-0ec6f742-9546-11f0-b41a-0242ac130006"; // REMPLACEZ PAR VOTRE CLÃ‰ API STORMGlass
    const spots = [
      { id: 'yoff', name: "Yoff", lat: 14.765, lon: -17.485 },
      { id: 'almadies', name: "Les Almadies", lat: 14.741, lon: -17.531 },
      { id: 'virage', name: "Le Virage", lat: 14.755, lon: -17.511 }
    ];

    function degToCompass(deg) {
      const dirs = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
      return dirs[Math.round(deg / 22.5) % 16];
    }

    function arrowSVG() {
      return `<svg class="arrow" viewBox="0 0 24 24">
        <path d="M12 2 L15 8 H13 V22 H11 V8 H9 L12 2 Z" fill="#075985"/>
      </svg>`;
    }

    async function fetchSpots() {
      const container = document.getElementById("spots");
      container.innerHTML = "<p class='col-span-3 text-center'>Chargement des donnÃ©es...</p>";
      const tideDiv = document.getElementById("tides");
      tideDiv.innerHTML = "<p class='text-center'>Chargement des marÃ©es...</p>";

      // Fetch spot data
      const spotData = await Promise.all(spots.map(async (spot) => {
          try {
              const url = `https://api.stormglass.io/v2/weather/point?lat=${spot.lat}&lng=${spot.lon}&params=swellHeight,swellPeriod,windWaveHeight,windWavePeriod,windDirection,windSpeed`;
              const res = await fetch(url, {
                  headers: { 'Authorization': API_KEY }
              });

              if (!res.ok) {
                  throw new Error(`Erreur de l'API: ${res.status}`);
              }

              const data = await res.json();
              const h = data.hours[0]; // Current hour data

              const waveHeight = h.swellHeight ? (h.swellHeight.value + h.windWaveHeight.value) : (h.windWaveHeight ? h.windWaveHeight.value : 0);
              const wavePeriod = h.swellPeriod ? (h.swellPeriod.value + h.windWavePeriod.value) / 2 : (h.windWavePeriod ? h.windWavePeriod.value : 0);
              const windSpeed = h.windSpeed ? h.windSpeed.value : 0;
              const windDir = h.windDirection ? h.windDirection.value : 0;
              
              return {
                  name: spot.name,
                  success: true,
                  data: {
                      wave_height: waveHeight,
                      wave_period: wavePeriod,
                      wind_speed: windSpeed,
                      wind_direction: windDir
                  }
              };

          } catch (err) {
              return { name: spot.name, success: false, error: err.message };
          }
      }));

      const resultsHTML = spotData.map(spot => {
          if (!spot.success) {
              return `<div class="bg-red-100 p-4 rounded-2xl shadow text-center flex items-center justify-center spot-card"><div><h2 class="text-lg font-bold mb-2">${spot.name}</h2><p class="text-sm text-red-700">Erreur de chargement: ${spot.error}</p></div></div>`;
          }

          const current = spot.data;

          return `<div class="bg-white p-4 rounded-2xl shadow text-center spot-card">
              <h2 class="text-lg font-bold mb-2">${spot.name}</h2>
              <div class="flex flex-col items-center mt-2">
                <span class="text-4xl">ðŸŒŠ</span>
                <div class="text-sm mt-1">taille = ${current.wave_height.toFixed(1)} m</div>
                <div class="text-sm">pÃ©riode = ${current.wave_period.toFixed(1)} s</div>
              </div>
              <div class="mt-3 text-sm text-gray-700">
                Vent : ${(current.wind_speed * 3.6).toFixed(1)} km/h (${degToCompass(current.wind_direction)})
              </div>
              <div class="mt-2 flex justify-center">${arrowSVG()}</div>
              <div class="mt-3 text-xs text-gray-500">
                Meilleure hauteur (48h) : N/A
              </div>
            </div>`;
      }).join("");

      container.innerHTML = resultsHTML;

      spotData.forEach((spot, i) => {
          if (spot.success) {
              const card = container.children[i];
              const arrow = card.querySelector(".arrow");
              if (arrow) {
                  const deg = spot.data.wind_direction;
                  arrow.style.transform = `rotate(${deg}deg)`;
              }
          }
      });

      // Fetch tide data (separate API call)
      try {
          const tideUrl = `https://api.stormglass.io/v2/tide/sea-level/point?lat=14.66&lng=-17.43`;
          const res = await fetch(tideUrl, {
              headers: { 'Authorization': API_KEY }
          });

          if (!res.ok) {
              throw new Error(`Erreur de l'API: ${res.status}`);
          }
          const data = await res.json();
          const levels = data.data;

          const now = new Date();
          let nextHigh = null, nextLow = null;

          for (let i = 1; i < levels.length - 1; i++) {
              const currentTime = new Date(levels[i].time);
              if (currentTime > now) {
                  if (levels[i].value > levels[i - 1].value && levels[i].value > levels[i + 1].value && !nextHigh) {
                      nextHigh = { time: levels[i].time, val: levels[i].value };
                  }
                  if (levels[i].value < levels[i - 1].value && levels[i].value < levels[i + 1].value && !nextLow) {
                      nextLow = { time: levels[i].time, val: levels[i].value };
                  }
              }
              if (nextHigh && nextLow) break;
          }

          tideDiv.innerHTML = `
            <h2 class="text-lg font-bold mb-3">ðŸŒŠ MarÃ©es Ã  Dakar</h2>
            <p class="text-sm">Prochaine marÃ©e haute : ${nextHigh ? new Date(nextHigh.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) + " (" + nextHigh.val.toFixed(1) + " m)" : "N/A"}</p>
            <p class="text-sm">Prochaine marÃ©e basse : ${nextLow ? new Date(nextLow.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) + " (" + nextLow.val.toFixed(1) + " m)" : "N/A"}</p>
          `;
      } catch (e) {
          tideDiv.innerHTML = `<p class="text-red-600">Erreur chargement marÃ©es: ${e.message}</p>`;
      }
    }

    document.getElementById("refreshBtn").addEventListener("click", fetchSpots);
    fetchSpots();
  </script>
</body>
</html>
