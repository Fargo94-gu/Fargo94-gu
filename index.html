C'est une excellente observation qui nous permet de diagnostiquer précisément le problème.
Voici ce que nous avons appris de ce dernier test :
 * Marées (loadTides) : Les données des marées étaient gérées précédemment par Stormglass. Open-Meteo et Weatherbit ne fournissant pas de données de marées publiques, j'ai mis des valeurs par défaut dans la dernière version. Le fait que vous ayez vu les données de marées dans la version précédente confirme que Stormglass fonctionnait pour les marées.
 * Spots (Vagues et Météo) : La fonction generateSpotConditions a besoin de la hauteur des vagues (waveHeight) et de la période des vagues (wavePeriod).
   * Open-Meteo fournit ces données (dans la version précédente, c'était le fallback).
   * Weatherbit (votre nouvelle clé) fournit la température et le vent, mais pas les vagues dans l'API gratuite/standard.
   * Stormglass fournissait ces données de vagues (quand il fonctionnait).
Conclusion :
Si les spots ne s'affichent pas dans la dernière version (Weatherbit + Open-Meteo), cela signifie qu'il y a un problème de compatibilité ou d'accès avec les données de vagues d'Open-Meteo lorsqu'elles sont utilisées pour les spots, ou que le code Open-Meteo est le seul à fonctionner et qu'il est écrasé par l'échec de Weatherbit.
Pour avoir les données des spots, nous avons besoin d'une source de données de vagues fiable.
Puisque nous avons confirmé que Stormglass fonctionnait pour les marées (il est donc au moins partiellement fonctionnel), il est très probable que Stormglass était également la seule API fournissant correctement les données de vagues pour les spots.
Action recommandée :
Nous allons remettre Stormglass en tant que source de données de vagues et de météo de secours, tout en gardant Weatherbit en première priorité pour la météo, et Open-Meteo en ultime recours.
Je vais remettre Stormglass en priorité pour les données de vagues dans generateSpotConditions, car il a déjà prouvé son efficacité pour ce type de données.
Code HTML/JavaScript avec Stormglass réintégré
Voici le code mis à jour. J'ai réintégré la clé et les appels de Stormglass pour qu'il gère les vagues et les marées si Weatherbit échoue.
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <title>Surf Spots Afrique — Live</title>
    
    <script src="https://cdn.tailwindcss.com"></script> <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="apple-touch-icon" href="https://i.imgur.com/7M2f6kA.png">
    <link rel="icon" href="https://i.imgur.com/7M2f6kA.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Surf Dakar">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <style>
        /* Mobile-First Typography */
        * { font-family: 'Inter', sans-serif; }
        
        /* Root Variables */
        :root {
            --primary: #075985;
            --accent: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-dark: rgba(0, 0, 0, 0.4);
        }
        
        [data-theme="dark"] {
            --glass: rgba(0, 0, 0, 0.5);
            color-scheme: dark;
        }
        
        /* Mobile Background */
        body {
            background: linear-gradient(135deg, #075985 0%, #0f766e 100%), url('data:image/svg+xml,%3Csvg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="%23ffffff" fill-opacity="0.02"%3E%3Ccircle cx="20" cy="20" r="1"/%3E%3C/g%3E%3C/svg%3E');
            background-size: cover, 40px 40px;
            background-attachment: fixed;
            color: white;
            min-height: 100vh;
            padding: 0.5rem;
            margin: 0;
            overflow-x: hidden;
        }
        
        /* Glass Cards Mobile */
        .glass {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin: 0.5rem 0;
            padding: 1rem;
        }
        
        .glass:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        /* Header Mobile */
        .header {
            text-align: center;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            background: linear-gradient(135deg, #ffffff, #e0f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* Navigation Tabs Mobile */
        .tabs {
            display: flex;
            background: var(--glass);
            border-radius: 0.75rem;
            overflow: hidden;
            margin: 1rem 0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }
        
        .tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .tab.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-weight: 600;
        }
        
        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }
        
        /* Weather Card Mobile */
        .weather-card {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--glass);
            border-radius: 0.75rem;
            margin: 0.25rem 0;
        }
        
        .weather-icon {
            font-size: 1.5rem;
            min-width: 2rem;
        }
        
        .weather-info h3 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: white;
        }
        
        .weather-info p {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
            line-height: 1.3;
        }
        
        .temp-main {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            margin: 0.25rem 0;
        }
        
        /* Tides Mobile */
        .tide-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin: 1rem 0;
        }
        
        .tide-card {
            text-align: center;
            padding: 0.75rem;
            background: var(--glass);
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .tide-type {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            opacity: 0.9;
        }
        
        .tide-time {
            font-size: 1.125rem;
            font-weight: 700;
            margin: 0.25rem 0;
        }
        
        .tide-height {
            font-size: 1.25rem;
            font-weight: 600;
            color: #10b981;
        }
        
        /* Spots Cards Mobile-Optimized */
        .spots-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .spot-card {
            background: var(--glass);
            border-radius: 1rem;
            padding: 1rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            min-height: 320px;
            display: flex;
            flex-direction: column;
        }
        
        .spot-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }
        
        .spot-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        
        .spot-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: white;
            margin: 0;
            line-height: 1.2;
        }
        
        .spot-badge {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.625rem;
            font-weight: 600;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .spot-icon {
            font-size: 1.25rem;
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            opacity: 0.8;
        }
        
        .spot-difficulty {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: inline-block;
            align-self: flex-start;
        }
        
        .difficulty-beginner { 
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e; 
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        .difficulty-intermediate { 
            background: rgba(245, 158, 11, 0.2);
            color: #f97316; 
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .difficulty-expert { 
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444; 
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .spot-description {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.4;
            margin-bottom: 0.75rem;
            flex-grow: 1;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Wave Conditions Mobile */
        .wave-conditions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .wave-icon {
            font-size: 1.75rem;
            animation: wavePulse 2s ease-in-out infinite;
        }
        
        @keyframes wavePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .wave-height {
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
            margin: 0;
        }
        
        .wave-period {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
            font-weight: 500;
        }
        
        /* Weather Conditions Compact */
        .weather-conditions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .weather-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            text-align: center;
        }
        
        .weather-icon {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .weather-value {
            font-size: 0.875rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.125rem;
        }
        
        .weather-label {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Wind Rose Compact */
        .wind-rose-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.75rem 0;
        }
        
        .wind-rose {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50px;
            width: 50px;
        }
        
        .wind-compass {
            position: absolute;
            font-size: 0.625rem;
            color: rgba(255, 255, 255, 0.6);
            z-index: 1;
            top: 0.25rem;
        }
        
        .wind-compass::after {
            content: 'S';
            position: absolute;
            bottom: 0.25rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.625rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .wind-compass::before {
            content: 'E';
            position: absolute;
            right: 0.25rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.625rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .wind-arrow {
            display: none; /* Supprime la flèche ➡️ */
        }
        
        .wind-star {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #3b82f6;
            font-size: 8px;
            z-index: 2;
            opacity: 0.8;
            transition: transform 0.3s ease;
            filter: drop-shadow(0 0 2px rgba(59, 130, 246, 0.5));
        }
        
        .wind-star::before {
            content: '⭐';
            display: block;
        }
        
        .wind-star.animate {
            animation: starRotate 2s linear infinite;
        }
        
        @keyframes starRotate {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .wind-details {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.9);
            max-width: 120px;
        }
        
        .wind-details p {
            margin: 0;
            line-height: 1.2;
            font-weight: 500;
        }
        
        .wind-details .label {
            font-weight: 600;
            color: white;
        }
        
        /* Rating Mobile */
        .rating-section {
            margin-top: auto;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .rating-title {
            font-size: 0.875rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .rating-excellent { color: #10b981; }
        .rating-good { color: #f59e0b; }
        .rating-fair { color: #f97316; }
        .rating-poor { color: #ef4444; }
        
        .progress-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .progress-bar {
            width: 120px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            flex: 1;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.8s ease;
        }
        
        .progress-text {
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 3rem;
            text-align: right;
        }
        
        /* Loading Mobile */
        .loading {
            text-align: center;
            padding: 2rem 1rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0.5rem auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Button Mobile */
        .btn {
            background: linear-gradient(135deg, var(--primary), #0c4a6e);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn:hover, .btn:active {
            background: linear-gradient(135deg, #0c4a6e, var(--primary));
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(7, 89, 133, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Alert Banner Mobile */
        .alert {
            position: fixed;
            top: 1rem;
            right: 1rem;
            left: 1rem;
            z-index: 1000;
            background: linear-gradient(135deg, #ef4444, #f59e0b);
            color: white;
            padding: 0.75rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            max-width: none;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* LOGO PERSONNALISÉ FG - EN HAUT À GAUCHE */
        .logo-container {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 100;
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: default;
            transition: all 0.3s ease;
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .logo-container:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.05) rotate(5deg);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
        }
        
        .logo {
            position: relative;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-initials {
            font-size: 16px;
            font-weight: 800;
            background: linear-gradient(135deg, #ffffff 0%, #e0f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 2;
            text-transform: uppercase;
            letter-spacing: -0.5px;
        }
        
        .logo-circle {
            position: absolute;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            top: 2px;
            left: 2px;
            z-index: 1;
            animation: logoPulse 3s ease-in-out infinite;
        }
        
        .logo-wave {
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 8px;
            background: rgba(16, 185, 129, 0.3);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            z-index: 0;
            animation: waveFloat 2s ease-in-out infinite;
        }
        
        @keyframes logoPulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
        }
        
        @keyframes waveFloat {
            0%, 100% { transform: translateX(-50%) translateY(0px); }
            50% { transform: translateX(-50%) translateY(-2px); }
        }
        
        /* Theme Toggle - EN HAUT À DROITE */
        .theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 100;
            background: var(--glass);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .hidden {
            display: none;
        }
        
        /* Responsive Mobile */
        @media (min-width: 768px) {
            .spots-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
            
            .weather-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 0.75rem;
            }
            
            .logo-container {
                width: 56px;
                height: 56px;
            }
            
            .logo {
                width: 40px;
                height: 40px;
            }
            
            .logo-initials {
                font-size: 20px;
            }
            
            .theme-toggle {
                width: 48px;
                height: 48px;
            }
        }
        
        /* Scrollbar Mobile */
        ::-webkit-scrollbar {
            width: 4px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }
        
        /* Status Bar */
        @media (display-mode: standalone) {
            body { padding-top: env(safe-area-inset-top); }
        }
    </style>
</head>
<body data-theme="light">
    
    <div class="logo-container" title="Surf Spots Afrique - FG">
        <div class="logo">
            <div class="logo-circle"></div>
            <div class="logo-wave"></div>
            <span class="logo-initials">FG</span>
        </div>
    </div>
    
    <button class="theme-toggle" onclick="toggleTheme()" title="Changer le thème">
        <span id="themeIcon">🌙</span>
    </button>
    
    <div id="alertBanner" class="alert hidden">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="text-lg">🚨</span>
                <div>
                    <div id="alertTitle" class="font-bold"></div>
                    <div id="alertMessage" class="text-sm"></div>
                </div>
            </div>
            <button onclick="hideAlert()" class="text-white hover:opacity-70">✕</button>
        </div>
    </div>
    
    <div class="container mx-auto">
        <div class="header glass">
            <h1 class="title">🌊 Surf Spots Afrique</h1>
            <p class="subtitle">Conditions en temps réel</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="loadData('dakar')">Dakar, Aujourd'hui</button>
            <button class="tab" onclick="loadData('maroc')">Maroc, Aujourd'hui</button>
        </div>
        
        <div class="glass">
            <h2 class="text-lg font-bold text-center mb-3">🌤️ Météo</h2>
            <div id="weatherContent" class="weather-grid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Chargement météo...</p>
                </div>
            </div>
        </div>
        
        <div class="glass">
            <h2 class="text-lg font-bold text-center mb-3">🌊 Marées</h2>
            <div id="tidesContent" class="tide-grid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Calcul marées...</p>
                </div>
            </div>
        </div>
        
        <div class="glass">
            <h2 class="text-lg font-bold text-center mb-3">🏄‍♂️ Spots de Surf</h2>
            <div id="spotsContent" class="spots-grid">
                <div class="loading col-span-full">
                    <div class="spinner"></div>
                    <p>Analyse conditions...</p>
                </div>
            </div>
        </div>
        
        <button id="refreshBtn" class="btn" onclick="loadData(currentRegion)">
            <span id="btnIcon">🔄</span>
            Actualiser
        </button>
        
        <div class="glass text-center py-2">
            <p class="text-sm opacity-70">Powered by Weatherbit, Storm Glass & Open-Meteo • Données réelles</p>
            <p class="text-xs opacity-60 mt-1" id="lastUpdate"></p>
        </div>
    </div>

    <script>
        // Clé API Weatherbit
        const WEATHERBIT_API_KEY = '5131829b18ce439fbe2275340622a651';
        // Clé API Stormglass (réintégrée)
        const STORMGLASS_API_KEY = '0ec6f6b6-9546-11f0-b41a-0242ac130006-0ec6f742-9546-11f0-b41a-0242ac130006';

        // Global State
        let weatherData = {};
        let lastUpdate = null;
        let updateInterval;
        let currentRegion = 'dakar'; // Région par défaut

        // Spots Data (inchangés)
        const spotsDakar = [
            { name: 'Yoff', lat: 14.6937, lon: -17.4441, icon: '🔥', description: 'Beach break exposé aux swells atlantiques' },
            { name: 'Les Almadies', lat: 14.7264, lon: -17.5078, icon: '🤙', description: 'Point break rocheux' },
            { name: 'Le Virage', lat: 14.7000, lon: -17.4600, icon: '🏄‍♂️', description: 'Beach break familial' },
            { name: 'Ngor', lat: 14.7260, lon: -17.5070, icon: '🏄‍♂️', description: 'Spot paradisiaque' },
            { name: 'Ouakam', lat: 14.7500, lon: -17.4700, icon: '🤙', description: 'Reef break technique' },
            { name: 'Secret Spot', lat: 14.6800, lon: -17.4200, icon: '🔥', description: 'Endroit caché' },
            { name: 'Vivier', lat: 14.7265, lon: -17.5080, icon: '🌊', description: 'Reef break puissant' },
            { name: 'Club Med', lat: 14.7270, lon: -17.5090, icon: '🏄', description: 'Reef break protégé' },
            { name: 'Yene', lat: 14.7280, lon: -17.5100, icon: '🤙', description: 'Reef break courtes' },
            { name: 'Ndayan', lat: 14.7500, lon: -17.4000, icon: '🌴', description: 'Beach break sauvage' },
            { name: 'Vivier Reef', lat: 14.7250, lon: -17.5090, icon: '🌊', description: 'Point break barrels' },
            { name: 'Mamelles', lat: 14.7300, lon: -17.5000, icon: '🤙', description: 'Reef break puissant' },
            { name: 'Petite Côte', lat: 14.5000, lon: -17.0000, icon: '🏝️', description: 'Beach breaks uncrowded' }
        ];

        const spotsMaroc = [
            { name: 'Anchor Point', lat: 30.138, lon: -9.697, icon: '🌊', description: 'Point break droit puissant', difficulty: 'expert' },
            { name: 'Hash Point', lat: 30.140, lon: -9.695, icon: '🔥', description: 'Spot technique avec barrels', difficulty: 'expert' },
            { name: 'Banana Beach', lat: 30.100, lon: -9.680, icon: '🏄‍♂️', description: 'Plage douce pour débutants', difficulty: 'beginner' },
            { name: 'Devil\'s Rock', lat: 30.095, lon: -9.675, icon: '🤙', description: 'Reef break fun', difficulty: 'intermediate' },
            { name: 'Imsouane', lat: 30.170, lon: -9.540, icon: '🏄', description: 'Long right-hand doux', difficulty: 'beginner' },
            { name: 'Sidi Kaouki', lat: 31.890, lon: -9.760, icon: '🌴', description: 'Vagues puissantes', difficulty: 'expert' },
            { name: 'Essaouira Beach', lat: 31.510, lon: -9.770, icon: '🏖️', description: 'Vagues douces', difficulty: 'beginner' },
            { name: 'Tamraght', lat: 30.090, lon: -9.670, icon: '🌊', description: 'Breaks variés', difficulty: 'all' },
            { name: 'Killer Point', lat: 30.135, lon: -9.698, icon: '🔥', description: 'Point break extrême', difficulty: 'expert' },
            { name: 'Panorama', lat: 30.145, lon: -9.690, icon: '🤙', description: 'Vue et vagues puissantes', difficulty: 'expert' }
        ];

        // Theme Toggle (inchangé)
        function toggleTheme() {
            const body = document.body;
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('themeIcon').textContent = isDark ? '☀️' : '🌙';
            localStorage.setItem('surf-theme', isDark ? 'light' : 'dark');
        }

        // Load Theme (inchangé)
        if (localStorage.getItem('surf-theme') === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('themeIcon').textContent = '☀️';
        }

        // --- FONCTION fetchWithFallback RÉVISÉE AVEC LES 3 APIS ---
        async function fetchWithFallback(lat, lon) {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const currentHour = now.getHours();
            const timezone = currentRegion === 'maroc' ? 'Africa/Casablanca' : 'Africa/Dakar';

            // Structure de données unifiée pour le retour
            let unifiedData = {
                airTemperature: null,
                windSpeed: null,
                windDirection: null,
                waveHeight: null,
                wavePeriod: null
            };

            // 1. TENTATIVE : Weatherbit (Météo SEULEMENT)
            try {
                const weatherbitUrl = `https://api.weatherbit.io/v2.0/forecast/hourly?lat=${lat}&lon=${lon}&key=${WEATHERBIT_API_KEY}&units=M&hours=24`;
                const response = await fetch(weatherbitUrl);
                if (!response.ok) throw new Error(`Weatherbit HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                const wbitData = data.data[currentHour];
                console.log('Succès Weatherbit pour la MÉTÉO:', wbitData);

                unifiedData.airTemperature = wbitData.temp;
                unifiedData.windSpeed = wbitData.wind_spd; // m/s
                unifiedData.windDirection = wbitData.wind_dir; // degrés
                
                // Si Weatherbit réussit, nous avons la meilleure info météo. On cherche les vagues avec Stormglass ou Open-Meteo.
            } catch (error) {
                console.error(`Erreur Weatherbit:`, error.message);
            }

            // 2. TENTATIVE : Stormglass (Vagues et Météo de secours)
            try {
                const stormglassUrl = `https://api.stormglass.io/v2/weather/point?lat=${lat}&lng=${lon}&params=waveHeight,wavePeriod,windSpeed,windDirection,airTemperature&source=noaa&start=${today}&end=${today}`;
                const response = await fetch(stormglassUrl, { headers: { 'Authorization': STORMGLASS_API_KEY } });
                if (!response.ok) throw new Error(`Stormglass HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                const sgData = data.hours[currentHour];
                
                console.log('Succès Stormglass pour VAGUES et MÉTÉO:', sgData);

                // On écrase les champs manquants avec les données Stormglass
                unifiedData.waveHeight = sgData.waveHeight?.noaa;
                unifiedData.wavePeriod = sgData.wavePeriod?.noaa;
                
                if (!unifiedData.airTemperature) unifiedData.airTemperature = sgData.airTemperature?.noaa;
                if (!unifiedData.windSpeed) unifiedData.windSpeed = sgData.windSpeed?.noaa;
                if (!unifiedData.windDirection) unifiedData.windDirection = sgData.windDirection?.noaa;

            } catch (error) {
                console.error(`Erreur Stormglass:`, error.message);
            }

            // 3. TENTATIVE : Open-Meteo (Ultime recours pour Vagues et Météo)
            try {
                // On n'appelle Open-Meteo que si nous manquons encore de données clés (vagues ou météo).
                if (!unifiedData.waveHeight || !unifiedData.airTemperature) {
                    const openmeteoUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=wave_height,wave_period,temperature_2m,wind_speed_10m,wind_direction_10m&timezone=${timezone}`;
                    const response = await fetch(openmeteoUrl);
                    if (!response.ok) throw new Error(`Open-Meteo HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    
                    console.log('Succès Open-Meteo (Ultime Recours):', data);

                    if (!unifiedData.waveHeight) unifiedData.waveHeight = data.hourly.wave_height[currentHour];
                    if (!unifiedData.wavePeriod) unifiedData.wavePeriod = data.hourly.wave_period[currentHour];
                    
                    // Si Weatherbit ou Stormglass ont déjà rempli les données, on ne les écrase pas
                    if (!unifiedData.airTemperature) unifiedData.airTemperature = data.hourly.temperature_2m[currentHour];
                    if (!unifiedData.windSpeed) unifiedData.windSpeed = data.hourly.wind_speed_10m[currentHour] / 3.6; // km/h vers m/s
                    if (!unifiedData.windDirection) unifiedData.windDirection = data.hourly.wind_direction_10m[currentHour];
                }
            } catch (error) {
                console.error(`Erreur Open-Meteo:`, error.message);
            }
            
            // Vérification finale des données essentielles
            if (unifiedData.waveHeight === null) {
                throw new Error("Impossible d'obtenir la hauteur des vagues à partir de toutes les sources.");
            }
            if (unifiedData.airTemperature === null) {
                throw new Error("Impossible d'obtenir la température à partir de toutes les sources.");
            }

            return unifiedData;
        }
        // --- FIN fetchWithFallback RÉVISÉE ---

        // Generate Spot Conditions (mise à jour pour la structure de retour de fetchWithFallback)
        async function generateSpotConditions(spot, spotList) {
            const now = new Date();
            const cacheKey = `spot_${spot.name}_${currentRegion}_${now.toISOString().split('T')[0]}`;

            try {
                // La fonction appelle fetchWithFallback qui retourne les meilleures données disponibles.
                const data = await fetchWithFallback(spot.lat, spot.lon);

                // L'extraction est directe
                const waveHeight = data.waveHeight;
                const wavePeriod = data.wavePeriod;
                const windSpeed_ms = data.windSpeed; 
                const windDirection = data.windDirection;
                const temp = data.airTemperature;

                // --- Logique d'évaluation et de formatage (inchangée) ---
                const windSpeed_kmh = Math.round(windSpeed_ms * 3.6);


                let dynamicDifficulty = spot.difficulty || 'beginner';
                if (waveHeight >= 0.8 && dynamicDifficulty !== 'expert') dynamicDifficulty = 'intermediate';
                else if (waveHeight >= 1.5) dynamicDifficulty = 'expert';

                const spotFacing = 220; 
                const windAngle = Math.abs(windDirection - spotFacing);
                const crossShore = Math.min(windAngle, 360 - windAngle);
                const windRelative = crossShore < 60 ? 'Onshore' : crossShore < 120 ? 'Cross' : 'Offshore';

                let score = 50;
                if (waveHeight > 0.5 && waveHeight < 2) score += 20;
                if (windRelative === 'Offshore') score += 25;
                if (windRelative === 'Cross') score += 10;
                if (windSpeed_kmh < 15) score += 10;
                score = Math.min(100, Math.max(0, score));

                const rating = score >= 80 ? 'excellent' : score >= 60 ? 'good' : score >= 40 ? 'fair' : 'poor';
                const ratingText = score >= 80 ? 'Excellent' : score >= 60 ? 'Bon' : score >= 40 ? 'Moyen' : 'Mauvais';

                const conditions = {
                    height: waveHeight.toFixed(1),
                    period: wavePeriod.toFixed(1),
                    windSpeed: windSpeed_kmh,
                    windDir: Math.round(windDirection),
                    windRelative,
                    temp: Math.round(temp),
                    score: Math.round(score),
                    rating,
                    ratingText,
                    dynamicDifficulty,
                    waveDirection: Math.round(spotFacing + (spotList.findIndex(s => s.name === spot.name) * 5))
                };
                localStorage.setItem(cacheKey, JSON.stringify(conditions));
                return conditions;
            } catch (error) {
                console.error(`Erreur conditions ${spot.name}:`, error);
                showAlert('Erreur de données', `Impossible de charger les conditions pour ${spot.name}. Cause: ${error.message}`, 'danger');
                const cachedData = localStorage.getItem(cacheKey);
                if (cachedData) {
                    return JSON.parse(cachedData);
                }
                throw new Error(`Aucune donnée disponible pour ${spot.name}`);
            }
        }

        // Load Weather
        async function loadWeather() {
            const lat = currentRegion === 'maroc' ? 30.138 : 14.6937;
            const lon = currentRegion === 'maroc' ? -9.697 : -17.4441;
            const now = new Date();
            const cacheKey = `weather_${currentRegion}_${now.toISOString().split('T')[0]}`;

            try {
                // Utilise fetchWithFallback pour obtenir les meilleures données météo
                const data = await fetchWithFallback(lat, lon);
                
                // Météo et vent (provenant de Weatherbit/Stormglass/Open-Meteo)
                const tempCurrent = data.airTemperature;
                const windSpeed_ms = data.windSpeed;
                const windDirection = data.windDirection;
                
                const tempMin = Math.round(Math.max(tempCurrent - 2, currentRegion === 'maroc' ? 15 : 25));
                const tempMax = Math.round(Math.min(tempCurrent + 3, currentRegion === 'maroc' ? 30 : 35));
                
                const windDir = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'][Math.round(windDirection / 45) % 8];

                const weatherData = { 
                    tempMin, 
                    tempMax, 
                    windSpeed: windSpeed_ms, // Stocké en m/s
                    windDir 
                };
                localStorage.setItem(cacheKey, JSON.stringify(weatherData));
                updateWeatherUI(weatherData);
            } catch (error) {
                console.error(`Erreur météo pour ${currentRegion}:`, error);
                showAlert('Erreur Météo', 'Impossible de charger les données météorologiques principales.', 'danger');
                const cachedData = localStorage.getItem(cacheKey);
                if (cachedData) {
                    updateWeatherUI(JSON.parse(cachedData));
                } else {
                    document.getElementById('weatherContent').innerHTML = '<div class="loading"><p>Échec API, pas de données disponibles.</p></div>';
                }
                document.getElementById('weatherContent').classList.add('active');
            }
        }

        // Load Tides (Utilise Stormglass qui est réintégré)
        async function loadTides() {
            const lat = currentRegion === 'maroc' ? 30.138 : 14.6937;
            const lon = currentRegion === 'maroc' ? -9.697 : -17.4441;
            const now = new Date();
            const start = new Date(now.setHours(0, 0, 0, 0)).toISOString();
            const end = new Date(now.setHours(23, 59, 59, 999)).toISOString();
            const cacheKey = `tides_${currentRegion}_${now.toISOString().split('T')[0]}`;
            
            document.getElementById('tidesContent').innerHTML = '<div class="loading"><div class="spinner"></div><p>Calcul marées...</p></div>';

            try {
                // Stormglass est la meilleure source pour les marées
                const response = await fetch(`https://api.stormglass.io/v2/tide/extremes/point?lat=${lat}&lng=${lon}&start=${start}&end=${end}`, {
                    headers: { 'Authorization': STORMGLASS_API_KEY }
                });
                if (!response.ok) throw new Error(`Stormglass HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                const highTide = data.data.find(t => t.type === 'high') || null;
                const lowTide = data.data.find(t => t.type === 'low') || null;
                
                if (!highTide || !lowTide) throw new Error("Marées non trouvées pour aujourd'hui.");

                const tideData = { highTide, lowTide, isEstimated: false };
                localStorage.setItem(cacheKey, JSON.stringify(tideData));
                updateTidesUI(tideData);
            } catch (error) {
                console.error(`Erreur marées pour ${currentRegion} (Stormglass):`, error);
                showAlert('Erreur Marées', 'Impossible de charger les données de marées (Stormglass). Affichage de l\'estimation.', 'warning');
                
                // Fallback vers l'estimation si Stormglass échoue
                const cachedData = localStorage.getItem(cacheKey);
                if (cachedData && !JSON.parse(cachedData).isEstimated) {
                    updateTidesUI(JSON.parse(cachedData)); // Utilise l'ancien cache si non estimé
                } else {
                    const defaultTides = {
                        highTide: { height: currentRegion === 'maroc' ? 3.5 : 2.0, time: new Date(new Date().setHours(11, 0)).toISOString() },
                        lowTide: { height: currentRegion === 'maroc' ? 1.0 : 0.5, time: new Date(new Date().setHours(17, 0)).toISOString() },
                        isEstimated: true
                    };
                    updateTidesUI(defaultTides);
                }
                document.getElementById('tidesContent').classList.add('active');
            }
        }

        // Load Spots (inchangé dans son principe)
        async function loadSpots(spotList) {
            const spotsContent = document.getElementById('spotsContent');
            spotsContent.innerHTML = '<div class="loading col-span-full"><div class="spinner"></div><p>Analyse conditions...</p></div>';
            
            let spotsHtml = '';
            for (const spot of spotList) {
                try {
                    const conditions = await generateSpotConditions(spot, spotList);
                    spotsHtml += `
                        <div class="spot-card">
                            <div class="spot-header">
                                <h3 class="spot-title">${spot.name}</h3>
                                <span class="spot-icon">${spot.icon}</span>
                            </div>
                            <span class="spot-difficulty difficulty-${conditions.dynamicDifficulty.toLowerCase()}">${conditions.dynamicDifficulty}</span>
                            <p class="spot-description">${spot.description}</p>
                            <div class="wave-conditions">
                                <span class="wave-icon">🌊</span>
                                <div>
                                    <p class="wave-height">${conditions.height}m</p>
                                    <p class="wave-period">${conditions.period}s</p>
                                </div>
                            </div>
                            <div class="weather-conditions">
                                <div class="weather-item">
                                    <span class="weather-icon">🌡️</span>
                                    <span class="weather-value">${conditions.temp}°</span>
                                    <span class="weather-label">Temp</span>
                                </div>
                                <div class="weather-item">
                                    <span class="weather-icon">💨</span>
                                    <span class="weather-value">${conditions.windSpeed} km/h</span>
                                    <span class="weather-label">${conditions.windRelative}</span>
                                </div>
                            </div>
                            <div class="wind-rose-container">
                                <div class="wind-rose">
                                    <span class="wind-compass">N</span>
                                    <span class="wind-star" style="transform: translate(-50%, -50%) rotate(${conditions.windDir + 180}deg);">⭐</span>
                                </div>
                                <div class="wind-details">
                                    <p><span class="label">Hauteur :</span> ${conditions.height}m</p>
                                    <p><span class="label">Période :</span> ${conditions.period}s</p>
                                    <p><span class="label">Vent :</span> ${conditions.windRelative}</p>
                                </div>
                            </div>
                            <div class="rating-section">
                                <p class="rating-title rating-${conditions.rating}">Note: ${conditions.ratingText}</p>
                                <div class="progress-container">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${conditions.score}%; background: ${conditions.rating === 'excellent' ? '#10b981' : conditions.rating === 'good' ? '#f59e0b' : conditions.rating === 'fair' ? '#f97316' : '#ef4444'}"></div>
                                    </div>
                                    <span class="progress-text">${conditions.score}/100</span>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error(`Erreur spot ${spot.name}:`, error);
                    spotsHtml += `
                        <div class="spot-card">
                            <div class="spot-header">
                                <h3 class="spot-title">${spot.name}</h3>
                                <span class="spot-icon">${spot.icon}</span>
                            </div>
                            <p class="text-center text-red-400">Échec API, pas de données disponibles.</p>
                        </div>
                    `;
                }
            }
            spotsContent.innerHTML = spotsHtml;
            document.getElementById('spotsContent').classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Load All Data (inchangé)
        async function loadData(region) {
            currentRegion = region;
            document.getElementById('refreshBtn').disabled = true;
            document.getElementById('btnIcon').textContent = '⏳';
            
            // Masquer les messages d'alerte précédents
            hideAlert();

            // Mettre à jour la date
            const dateStr = new Date().toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.textContent = tab.textContent.includes('Dakar') ? `Dakar, ${dateStr}` : `Maroc, ${dateStr}`;
                tab.classList.remove('active');
            });
            document.querySelector(`.tab[onclick="loadData('${currentRegion}')"]`).classList.add('active');
            
            // Lancer les chargements en parallèle
            await Promise.all([
                loadWeather(),
                loadTides(),
                loadSpots(currentRegion === 'maroc' ? spotsMaroc : spotsDakar)
            ]);
            
            lastUpdate = new Date();
            document.getElementById('lastUpdate').textContent = `Dernière mise à jour: ${lastUpdate.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}`;
            document.getElementById('refreshBtn').disabled = false;
            document.getElementById('btnIcon').textContent = '🔄';
        }

        // Fonctions utilitaires pour mise à jour UI (légère modification pour les marées)
        function updateWeatherUI(data) {
            const windSpeed_kmh = Math.round(data.windSpeed * 3.6);
            
            document.getElementById('weatherContent').innerHTML = `
                <div class="weather-card">
                    <span class="weather-icon">🌤️</span>
                    <div class="weather-info">
                        <h3>Aujourd'hui</h3>
                        <p class="temp-main">${data.tempMin}/${data.tempMax}°</p>
                        <p>Actuel</p>
                    </div>
                </div>
                <div class="weather-card">
                    <span class="weather-icon">💨</span>
                    <div class="weather-info">
                        <h3>Vent</h3>
                        <p class="temp-main">${windSpeed_kmh} km/h</p>
                        <p>${data.windDir}</p>
                    </div>
                </div>
            `;
            document.getElementById('weatherContent').classList.add('active');
        }

        function updateTidesUI(data) {
            const estimationTag = data.isEstimated ? 'Donnée estimée' : 'Donnée réelle';

            document.getElementById('tidesContent').innerHTML = `
                <div class="tide-card">
                    <div class="tide-type text-blue-400">Haute</div>
                    <div class="tide-time">${new Date(data.highTide.time).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</div>
                    <div class="tide-height">${data.highTide.height.toFixed(1)}m</div>
                    <p class="text-sm text-white opacity-80 mt-1">${estimationTag}</p>
                </div>
                <div class="tide-card">
                    <div class="tide-type text-red-400">Basse</div>
                    <div class="tide-time">${new Date(data.lowTide.time).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</div>
                    <div class="tide-height">${data.lowTide.height.toFixed(1)}m</div>
                    <p class="text-sm text-white opacity-80 mt-1">${estimationTag}</p>
                </div>
            `;
            document.getElementById('tidesContent').classList.add('active');
        }
        
        // Fonctions Alertes (légère amélioration pour les types)
        function showAlert(title, message, type = 'danger') {
            const alertBanner = document.getElementById('alertBanner');
            const alertTitle = document.getElementById('alertTitle');
            const alertMessage = document.getElementById('alertMessage');
            
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            
            alertBanner.style.background = ''; 
            if (type === 'danger') {
                 alertBanner.style.background = 'linear-gradient(135deg, #ef4444, #f59e0b)';
            } else if (type === 'warning') {
                alertBanner.style.background = 'linear-gradient(135deg, #f59e0b, #facc15)';
            }

            alertBanner.classList.remove('hidden');
            
            setTimeout(hideAlert, 5000);
        }

        function hideAlert() {
            document.getElementById('alertBanner').classList.add('hidden');
        }

        // Initial Load
        window.onload = function() {
            loadData('dakar');
        };
    </script>
</body>
</html>

