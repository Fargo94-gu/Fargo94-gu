<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Surf Spots Dakar â€” Live</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
        background: url('https://images.unsplash.com/photo-1517409477526-a664dd38b1f4?q=80&w=2670&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D') no-repeat center center fixed;
        background-size: cover;
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto;
        color: #075985;
    }
    .card {
        background-color: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
    .arrow { display:inline-block; width:36px; height:36px; transform-origin: center center; transition: transform 0.4s ease; }
    .spot-card { min-height:220px; }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center p-6">
  <h1 class="text-2xl font-bold mb-6 text-white text-shadow-lg">ðŸŒŠ Surf Spots - Dakar (live)</h1>

  
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-6xl mb-6">
    <div id="weather-today" class="card p-6 rounded-2xl shadow-xl flex flex-col items-center justify-center">
      <p>Chargement de la mÃ©tÃ©o...</p>
    </div>

    <div id="weather-tomorrow" class="card p-6 rounded-2xl shadow-xl flex flex-col items-center justify-center">
      <p>Chargement de la mÃ©tÃ©o...</p>
    </div>
    
    <div id="weather-hourly" class="card p-6 rounded-2xl shadow-xl md:col-span-2 lg:col-span-1">
      <p>Chargement des prÃ©visions...</p>
    </div>
  </div>

  <div id="weather-weekly" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 w-full max-w-6xl mb-6">
    <p class='col-span-7 text-center card p-4 rounded-2xl'>Chargement des prÃ©visions de la semaine...</p>
  </div>
  
  <div id="spots" class="grid md:grid-cols-3 gap-6 w-full max-w-6xl"></div>

  <div id="tides" class="mt-10 card p-4 rounded-2xl shadow w-full max-w-3xl text-center"></div>

  <button id="refreshBtn" class="mt-6 px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700">
    Actualiser les donnÃ©es
  </button>

  <script>
    const API_KEY_WorldTides = "0278aae2-48dd-421e-82d6-421baaa31786";

    const spots = [
      { id: 'yoff', name: "Yoff", lat: 14.765, lon: -17.485 },
      { id: 'almadies', name: "Les Almadies", lat: 14.741, lon: -17.531 },
      { id: 'virage', name: "Le Virage", lat: 14.755, lon: -17.511 },
      { id: 'ngor', name: "Ngor", lat: 14.7514, lon: -17.5164 },
      { id: 'ouakam', name: "Ouakam", lat: 14.7163, lon: -17.4897 },
      { id: 'secret_spot', name: "Secret Spot", lat: 14.736, lon: -17.513 }
    ];

    function degToCompass(deg) {
      const dirs = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
      return dirs[Math.round(deg / 22.5) % 16];
    }

    function arrowSVG() {
      return `<svg class="arrow" viewBox="0 0 24 24">
        <path d="M12 2 L15 8 H13 V22 H11 V8 H9 L12 2 Z" fill="#075985"/>
      </svg>`;
    }
    
    function getWeatherIcon(iconCode) {
        const iconMap = {
            '01d': 'â˜€ï¸', '01n': 'ðŸŒ™', '02d': 'ðŸŒ¤ï¸', '02n': 'â˜ï¸',
            '03d': 'â˜ï¸', '03n': 'â˜ï¸', '04d': 'ðŸŒ¥ï¸', '04n': 'ðŸŒ¥ï¸',
            '09d': 'ðŸŒ§ï¸', '09n': 'ðŸŒ§ï¸', '10d': 'ðŸŒ¦ï¸', '10n': 'ðŸŒ§ï¸',
            '11d': 'â›ˆï¸', '11n': 'â›ˆï¸', '13d': 'ðŸŒ¨ï¸', '13n': 'ðŸŒ¨ï¸',
            '50d': 'ðŸŒ«ï¸', '50n': 'ðŸŒ«ï¸'
        };
        return iconMap[iconCode] || 'â“';
    }

    async function fetchWeatherData() {
      const todayDiv = document.getElementById("weather-today");
      const tomorrowDiv = document.getElementById("weather-tomorrow");
      const hourlyDiv = document.getElementById("weather-hourly");
      const weeklyDiv = document.getElementById("weather-weekly");
      
      const dakarLat = 14.7645;
      const dakarLon = -17.3660;

      try {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${dakarLat}&longitude=${dakarLon}&hourly=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Africa%2FCasablanca`;
        const res = await fetch(url);
        if (!res.ok) {
          throw new Error(`Erreur de l'API Open-Meteo: ${res.status}`);
        }
        const data = await res.json();
        
        // Aujourd'hui
        const currentHourIndex = data.hourly.time.findIndex(time => new Date(time) >= new Date());
        const todayForecast = data.daily[0];
        const currentHourData = data.hourly.temperature_2m[currentHourIndex];
        
        todayDiv.innerHTML = `
          <h2 class="text-xl font-bold mb-2">Aujourd'hui</h2>
          <div class="flex items-center space-x-4">
            <span class="text-4xl">${getWeatherIcon(data.hourly.weather_code[currentHourIndex])}</span>
            <div>
              <p class="text-3xl font-bold">${currentHourData.toFixed(0)}Â°C</p>
              <p class="text-sm capitalize">${getWeatherDescription(data.hourly.weather_code[currentHourIndex])}</p>
            </div>
          </div>
          <div class="mt-4 text-xs">
              <p>Min : ${todayForecast.temperature_2m_min.toFixed(0)}Â°C | Max : ${todayForecast.temperature_2m_max.toFixed(0)}Â°C</p>
              <p>Vent : ${(data.hourly.wind_speed_10m[currentHourIndex] * 3.6).toFixed(0)} km/h (${degToCompass(data.hourly.wind_direction_10m[currentHourIndex])})</p>
          </div>
        `;
        
        // Demain
        const tomorrowForecast = data.daily[1];
        tomorrowDiv.innerHTML = `
          <h2 class="text-xl font-bold mb-2">Demain</h2>
          <div class="flex items-center space-x-4">
            <span class="text-4xl">${getWeatherIcon(tomorrowForecast.weather_code)}</span>
            <div>
              <p class="text-3xl font-bold">${tomorrowForecast.temperature_2m_max.toFixed(0)}Â°C</p>
              <p class="text-sm capitalize">${getWeatherDescription(tomorrowForecast.weather_code)}</p>
            </div>
          </div>
          <div class="mt-4 text-xs">
              <p>Min : ${tomorrowForecast.temperature_2m_min.toFixed(0)}Â°C | Max : ${tomorrowForecast.temperature_2m_max.toFixed(0)}Â°C</p>
              <p>Vent : N/A</p>
          </div>
        `;

        // PrÃ©visions horaires (prochaines 24h)
        let hourlyHtml = '<h3 class="text-md font-bold mb-2">Prochaines heures</h3><div class="flex overflow-x-auto space-x-4 pb-2">';
        for (let i = 0; i < 24; i++) {
          const hourData = data.hourly;
          const time = new Date(hourData.time[currentHourIndex + i]).getHours();
          hourlyHtml += `
            <div class="text-center flex-shrink-0">
              <p class="text-sm">${time}:00</p>
              <span class="text-xl">${getWeatherIcon(hourData.weather_code[currentHourIndex + i])}</span>
              <p class="text-xs">${hourData.temperature_2m[currentHourIndex + i].toFixed(0)}Â°C</p>
            </div>
          `;
        }
        hourlyHtml += '</div>';
        hourlyDiv.innerHTML = hourlyHtml;

        // PrÃ©visions de la semaine
        let weeklyHtml = '';
        const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
        for (let i = 1; i < 8; i++) {
          const dayData = data.daily[i];
          const dayIndex = (new Date().getDay() + i) % 7;
          weeklyHtml += `
            <div class="card p-3 rounded-xl shadow-md flex flex-col items-center text-center">
              <p class="text-sm font-semibold mb-1">${dayNames[dayIndex]}</p>
              <span class="text-xl">${getWeatherIcon(dayData.weather_code)}</span>
              <p class="text-xs font-bold">${dayData.temperature_2m_max.toFixed(0)}Â°C</p>
              <p class="text-xs text-gray-600">${dayData.temperature_2m_min.toFixed(0)}Â°C</p>
            </div>
          `;
        }
        weeklyDiv.innerHTML = weeklyHtml;

      } catch (e) {
        todayDiv.innerHTML = `<p class="text-red-600">Erreur mÃ©tÃ©o: ${e.message}</p>`;
        tomorrowDiv.innerHTML = `<p class="text-red-600">Erreur mÃ©tÃ©o: ${e.message}</p>`;
        hourlyDiv.innerHTML = `<p class="text-red-600">Erreur mÃ©tÃ©o: ${e.message}</p>`;
        weeklyDiv.innerHTML = `<p class="text-red-600">Erreur mÃ©tÃ©o: ${e.message}</p>`;
      }
    }

    function getWeatherDescription(code) {
        const descriptions = {
            0: "Ciel clair", 1: "Principalement dÃ©gagÃ©", 2: "Partiellement nuageux", 3: "Nuageux",
            45: "Brouillard", 48: "Brouillard de givre", 51: "Bruine lÃ©gÃ¨re", 53: "Bruine modÃ©rÃ©e",
            55: "Bruine dense", 56: "Bruine verglaÃ§ante lÃ©gÃ¨re", 57: "Bruine verglaÃ§ante dense",
            61: "Pluie lÃ©gÃ¨re", 63: "Pluie modÃ©rÃ©e", 65: "Pluie forte", 66: "Pluie verglaÃ§ante lÃ©gÃ¨re",
            67: "Pluie verglaÃ§ante forte", 71: "Chute de neige lÃ©gÃ¨re", 73: "Chute de neige modÃ©rÃ©e",
            75: "Chute de neige forte", 77: "Grains de neige", 80: "Averses de pluie lÃ©gÃ¨res",
            81: "Averses de pluie modÃ©rÃ©es", 82: "Averses de pluie fortes", 85: "Averses de neige lÃ©gÃ¨res",
            86: "Averses de neige fortes", 95: "Orage", 96: "Orage avec grÃªle", 99: "Orage avec grÃªle forte"
        };
        return descriptions[code] || "Conditions inconnues";
    }

    async function fetchSpotData(spot) {
      // Ce code utilise l'API Marine d'Open-Meteo
      try {
          const url = `https://marine-api.open-meteo.com/v1/marine?latitude=${spot.lat}&longitude=${spot.lon}&hourly=wave_height,wave_period,wind_speed_10m,wind_direction_10m&timezone=Africa%2FCasablanca`;
          const res = await fetch(url);
          if (!res.ok) {
              throw new Error(`Erreur de l'API Open-Meteo Marine: ${res.status}`);
          }
          const data = await res.json();
          if (!data.hourly || data.hourly.time.length === 0) {
              throw new Error("DonnÃ©es de vagues non disponibles");
          }
          
          const nowIndex = data.hourly.time.findIndex(time => new Date(time) >= new Date());
          const h = data.hourly;
          
          const waveHeight = h.wave_height[nowIndex] || 0;
          const wavePeriod = h.wave_period[nowIndex] || 0;
          const windSpeed = h.wind_speed_10m[nowIndex] || 0;
          const windDir = h.wind_direction_10m[nowIndex] || 0;
          
          return {
              name: spot.name,
              success: true,
              data: {
                  wave_height: waveHeight,
                  wave_period: wavePeriod,
                  wind_speed: windSpeed,
                  wind_direction: windDir
              }
          };
      } catch (err) {
          return { name: spot.name, success: false, error: err.message };
      }
    }

    async function fetchTideData() {
        const tideDiv = document.getElementById("tides");
        tideDiv.innerHTML = "<p class='text-center'>Chargement des marÃ©es...</p>";
        try {
            const today = new Date().toISOString().split('T')[0];
            const tideUrl = `https://www.worldtides.info/api?extremes&lat=14.66&lon=-17.43&key=${API_KEY_WorldTides}&date=${today}`;
            const res = await fetch(tideUrl);
            if (!res.ok) {
                throw new Error(`Erreur de l'API: ${res.status}`);
            }
            const data = await res.json();
            if (!data.extremes || data.extremes.length === 0) {
                throw new Error("DonnÃ©es de marÃ©e non disponibles");
            }
            const extremes = data.extremes;
            const now = new Date();
            let nextHigh = null, nextLow = null;
            for (const extreme of extremes) {
                const extremeTime = new Date(extreme.dt * 1000);
                if (extremeTime > now) {
                    if (extreme.type === 'High' && !nextHigh) {
                        nextHigh = { time: extremeTime, val: extreme.height };
                    } else if (extreme.type === 'Low' && !nextLow) {
                        nextLow = { time: extremeTime, val: extreme.height };
                    }
                }
                if (nextHigh && nextLow) break;
            }
            tideDiv.innerHTML = `
                <h2 class="text-lg font-bold mb-3">ðŸŒŠ MarÃ©es Ã  Dakar</h2>
                <p class="text-sm">Prochaine marÃ©e haute : ${nextHigh ? new Date(nextHigh.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) + " (" + nextHigh.val.toFixed(1) + " m)" : "N/A"}</p>
                <p class="text-sm">Prochaine marÃ©e basse : ${nextLow ? new Date(nextLow.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) + " (" + nextLow.val.toFixed(1) + " m)" : "N/A"}</p>
            `;
        } catch (e) {
            tideDiv.innerHTML = `<p class="text-red-600">Erreur chargement marÃ©es: ${e.message}</p>`;
        }
    }

    async function initializePage() {
      const container = document.getElementById("spots");
      container.innerHTML = "<p class='col-span-3 text-center'>Chargement des donnÃ©es...</p>";

      fetchWeatherData();
      fetchTideData();
      
      const spotData = await Promise.all(spots.map(fetchSpotData));
      
      const resultsHTML = spotData.map(spot => {
          if (!spot.success) {
              return `<div class="bg-red-100 p-4 rounded-2xl shadow text-center flex items-center justify-center spot-card card"><div><h2 class="text-lg font-bold mb-2">${spot.name}</h2><p class="text-sm text-red-700">Erreur de chargement: ${spot.error}</p></div></div>`;
          }

          const current = spot.data;

          return `<div class="p-4 rounded-2xl shadow text-center spot-card card">
              <h2 class="text-lg font-bold mb-2">${spot.name}</h2>
              <div class="flex flex-col items-center mt-2">
                <span class="text-4xl">ðŸŒŠ</span>
                <div class="text-sm mt-1">taille = ${current.wave_height.toFixed(1)} m</div>
                <div class="text-sm">pÃ©riode = ${current.wave_period.toFixed(1)} s</div>
              </div>
              <div class="mt-3 text-sm text-gray-700">
                Vent : ${(current.wind_speed * 3.6).toFixed(1)} km/h (${degToCompass(current.wind_direction)})
              </div>
              <div class="mt-2 flex justify-center">${arrowSVG()}</div>
              <div class="mt-3 text-xs text-gray-500">
                Meilleure hauteur (48h) : N/A
              </div>
            </div>`;
      }).join("");

      container.innerHTML = resultsHTML;

      spotData.forEach((spot, i) => {
          if (spot.success) {
              const card = container.children[i];
              const arrow = card.querySelector(".arrow");
              if (arrow) {
                  const deg = spot.data.wind_direction;
                  arrow.style.transform = `rotate(${deg}deg)`;
              }
          }
      });
    }

    document.getElementById("refreshBtn").addEventListener("click", initializePage);
    initializePage();
  </script>
</body>
</html>
